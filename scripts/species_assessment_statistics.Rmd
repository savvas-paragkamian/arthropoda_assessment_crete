---
title: "Arthropoda species assessment results"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: yes
    toc_depth: 2
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Load the data

```{r, warning=FALSE, message=FALSE, echo=T, results='hide'}
library(tidyverse)
library(sf)
library(knitr)
source("species_assessment_functions.R")

g_base <- g_base()
```

```{r, warning=FALSE, message=FALSE, echo=T, results='hide'}
locations_shp <- sf::st_read("../data/arthropods_occurrences/arthropods_occurrences.shp")
crete_shp <- sf::st_read("../data/crete/crete.shp")
endemic_species <- read_delim("../results/endemic_species_paca.tsv", delim="\t")
natura_crete <- sf::st_read("../data/natura2000/natura2000_crete.shp")
wdpa_crete <- sf::st_read("../data/wdpa_crete/wdpa_crete.shp")

natura_crete_land <- st_intersection(natura_crete, crete_shp)

# split the SPA SCI

natura_crete_land_sci <- natura_crete_land %>% filter(SITETYPE=="B")
## Hotspots and threadspots
endemic_hotspots <- st_read("../results/endemic_hotspots/endemic_hotspots.shp")
threadspots <- st_read("../results/threadspots/threadspots.shp")

```
There are `r nrow(locations_shp)` occurrences of `r length(unique(locations_shp$sbspcsn))` 
species that belong to `r length(unique(locations_shp$Order))` orders.

## Protected Areas

```{r, warning=FALSE, message=FALSE, echo=T}
wdpa_crete$area <- units::set_units(st_area(wdpa_crete),km^2)

wdpa_crete_all <- data.frame(name="total protected", 
                             area=sum(wdpa_crete$area))

wdpa_crete_combine <- st_union(wdpa_crete) %>%
    st_make_valid() %>%
    st_as_sf() %>% 
    filter(st_geometry_type(.) %in% c("MULTIPOLYGON"))

wdpa_crete_combine_area <- data.frame(name="total protected (no overlap)",
                                      area=sum(units::set_units(st_area(wdpa_crete_combine), km^2)))
crete_area <- data.frame(name="crete",
                         area=sum(units::set_units(st_area(crete_shp), km^2)))

protected_area <- wdpa_crete %>% 
    group_by(DESIG_ENG) %>%
    summarise(area=sum(area)) %>%
    st_drop_geometry() %>%
    dplyr::rename("name"="DESIG_ENG") %>%
    bind_rows(crete_area,wdpa_crete_all, wdpa_crete_combine_area) %>%
    arrange(area) %>%
    mutate(area=round(area,2))

kable(protected_area)

```

```{r, warning=FALSE, message=FALSE, echo=T}

g_wdpa <- g_base +
    geom_sf(wdpa_crete, mapping=aes(fill=DESIG_ENG),alpha=0.5, size=0.1)+
    theme_bw()+
    theme(legend.position="bottom", legend.margin=margin())+
    guides(fill=guide_legend(nrow=5,byrow=TRUE, title=""))

ggsave("../plots/wdpa_protected_aread.png", g_wdpa, device="png")

g_wdpa
```

# PACA - Preliminary Automated Conservation Assessment

The PACA categories results. LT = CR + EN, PT = VU, PNT = NT and LC.
```{r, warning=FALSE, message=FALSE, echo=T}

endemic_species_p <- endemic_species %>% 
    group_by(paca) %>%
    summarise(n_species=n(), .groups="drop") %>%
    rename("category"="paca") %>%
    mutate(method="paca")

endemic_species_i <- endemic_species %>% 
    group_by(iucn) %>%
    summarise(n_species=n(), .groups="drop") %>%
    rename("category"="iucn") %>%
    mutate(method = "iucn") %>%
    bind_rows(endemic_species_p)

g_paca <- ggplot() +
    geom_col(data=endemic_species_i, 
             aes(x=n_species,y=method, fill=category), 
             show.legend=T, position = position_stack(reverse = TRUE))+
    theme_bw() +
    guides(fill=guide_legend(ncol=2)) 

ggsave("../plots/bar_chart_paca.png", g_paca, device="png")
g_paca
```

IUCN categories per Order:

```{r, warning=FALSE, message=FALSE, echo=T}

endemic_species_s_i <- endemic_species %>% 
    group_by(iucn, Order) %>%
    summarise(n_species=n(), .groups="drop")

g_iucn_o <- ggplot() +
    geom_col(data=endemic_species_s_i, aes(x=n_species,y=Order, fill=iucn), show.legend=T)+
    theme_bw()

ggsave("../plots/bar_chart_iucn_order.png", g_iucn_o, device="png")
g_iucn_o

```
PACA categories per Order:

```{r, warning=FALSE, message=FALSE, echo=T}

endemic_species_s_o <- endemic_species %>% 
    group_by(paca, Order) %>%
    summarise(n_species=n(), .groups="drop") %>%
    mutate(paca = gsub("FALSE", "PNT",paca))

g_paca_o <- ggplot() +
    geom_col(data=endemic_species_s_o, aes(x=n_species,y=Order, fill=paca), show.legend=T)+
    theme_bw()

ggsave("../plots/bar_chart_paca_order.png", g_paca_o, device="png")
g_paca_o

```

# Hotspots and threadspots
Here are the hotspots and threadspots of the analysis.
Endemic hotspots are the grid cells that contain the 10% 
of the endemic species.


![Crete endemic hotspots]("../plots/crete-hotspots.png")


![Crete endemic hotspots per order]("../plots/crete-hotspots_order.png")


![Crete endemic threadspots]("../plots/crete-threadspots.png")


![Crete endemic threadspots per order]("../plots/crete-threadspots_order.png")


![Overlap of hotspots with threadspots](""../plots/crete-hotspots-threadspots.png"")



```{r, warning=FALSE, message=FALSE, echo=T}

threadspots_lt <- threadspots %>% 
    filter(pc_thrt>= quantile(pc_thrt,0.90))

intersection_spots <- endemic_hotspots %>%
    st_drop_geometry() %>%
    inner_join(.,threadspots_lt, by=c("CELLCODE"="CELLCOD")) %>%
    st_as_sf()

g_e_t <- g_base +
    geom_sf(intersection_spots, mapping=aes(fill="red"), alpha=0.3, size=0.1, na.rm = TRUE) +
    ggtitle("Endemic hotspots and Threadspots")+
#    scale_fill_gradient(low = "yellow", high = "red", na.value = "transparent")+
    theme_bw()

ggsave("../plots/crete-hotspots-threadspots.png", plot=g_e_t, device="png")

g_e_t

```

Overlap of hotspots and threadspots with Natura2000 protected areas.

```{r, warning=FALSE, message=FALSE, echo=T}

endemic_hotspots_natura <- st_intersection(endemic_hotspots, natura_crete_land_sci)
print("Total area of endemic hotspots")
sum(units::set_units(st_area(endemic_hotspots),km^2))

print("Overlap area of endemic hotspots with Natura2000 sci")
sum(units::set_units(st_area(endemic_hotspots_natura),km^2))

```
Threadspots with Natura2000

```{r, warning=FALSE, message=FALSE, echo=T}
threadspots_natura <- st_intersection(threadspots_lt, natura_crete_land_sci)

print("Total area of threadspots as they were inferred with the PACA method")
sum(units::set_units(st_area(threadspots_lt),km^2))

print("Ovelap area of the PACA threadspots")
sum(units::set_units(st_area(threadspots_natura),km^2))
```

# EOO and AOO distributions


The relation of EOO and AOO per IUCN category
```{r, , warning=FALSE, message=FALSE, echo=T}

g_e_o <- ggplot() +
    geom_point(endemic_species,mapping = aes(x=aoo_area, y=eoo, color=iucn)) +
    theme_bw()
ggsave("../plots/aoo-eoo_dist.png", plot=g_e_o, device="png")

g_e_o

g_e_o_order <- ggplot() +
    geom_point(endemic_species,mapping = aes(x=aoo_area, y=eoo, color=iucn)) +
    theme_bw() +
    facet_wrap(vars(Order), ncol=4, scales = "free")

ggsave("../plots/aoo-eoo_order.png", 
       plot=g_e_o_order, 
       device="png", 
       height = 20, 
       width = 20, 
       units="cm")

g_e_o_order
```

```{r, , warning=FALSE, message=FALSE, echo=T}

g_paca_e_o <- ggplot() +
    geom_point(endemic_species,mapping = aes(x=aoo_area, y=eoo, color=paca)) +
    theme_bw()
ggsave("../plots/aoo-eoo_dist_paca.png", plot=g_paca_e_o, device="png")

g_paca_e_o
```
