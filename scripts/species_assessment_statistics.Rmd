---
title: "Arthropoda species assessment results"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: yes
    toc_depth: 2
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Load the data

```{r, warning=FALSE, message=FALSE, echo=T}
library(tidyverse)
library(sf)
source("species_assessment_functions.R")

g_base <- g_base()
```

```{r, warning=FALSE, message=FALSE, echo=T}
locations_shp <- sf::st_read("../data/arthropods_occurrences/arthropods_occurrences.shp")
crete_shp <- sf::st_read("../data/crete/crete.shp")
endemic_species <- read_delim("../results/endemic_species_paca.tsv", delim="\t")
natura_crete <- sf::st_read("../data/natura2000/natura2000_crete.shp")

natura_crete_land <- st_intersection(natura_crete, crete_shp)

# split the SPA SCI

natura_crete_land_sci <- natura_crete_land %>% filter(SITETYPE=="B")
```
There are `r nrow(locations_shp)` occurrences of `r length(unique(locations_shp$subspeciesname))` 
species that belong to `r length(unique(locations_shp$Order))` orders.

# PACA - Preliminary Automated Conservation Assessment

The PACA categories results. LT = CR + EN, PT = VU, PNT = NT and LC.
```{r, warning=FALSE, message=FALSE, echo=T}

endemic_species_s <- endemic_species %>% 
    group_by(paca) %>%
    summarise(n_species=n()) %>%
    mutate(paca = gsub("FALSE", "PNT",paca))

g_paca <- ggplot() +
    geom_col(data=endemic_species_s, aes(x=n_species,y=paca, fill=paca), show.legend=T)+
    theme_bw()

ggsave("../results/bar_chart_paca.png", g_paca, device="png")
g_paca
```

PACA categories per Order:

```{r, warning=FALSE, message=FALSE, echo=T}

endemic_species_s_o <- endemic_species %>% 
    group_by(paca, Order) %>%
    summarise(n_species=n(), .groups="drop") %>%
    mutate(paca = gsub("FALSE", "PNT",paca))

g_paca_o <- ggplot() +
    geom_col(data=endemic_species_s_o, aes(x=n_species,y=Order, fill=paca), show.legend=T)+
    theme_bw()

ggsave("../results/bar_chart_paca_order.png", g_paca_o, device="png")
g_paca_o

```

# Hotspots and threadspots
Here are the hotspots and threadspots of the analysis.
Endemic hotspots are the grid cells that contain the 10% 
of the endemic species.


![Crete endemic hotspots]("../plots/crete-hotspots.png")


![Crete endemic hotspots per order]("../plots/crete-hotspots_order.png")


![Crete endemic threadspots]("../plots/crete-threadspots.png")


![Crete endemic threadspots per order]("../plots/crete-threadspots_order.png")


![Overlap of hotspots with threadspots](""../plots/crete-hotspots-threadspots.png"")



```{r, warning=FALSE, message=FALSE, echo=T}

endemic_hotspots <- st_read("../results/endemic_hotspots/endemic_hotspots.shp")
threadspots <- st_read("../results/threadspots/threadspots.shp")

threadspots_lt <- threadspots %>% 
    filter(pc_thrt>= quantile(pc_thrt,0.90))

intersection_spots <- endemic_hotspots %>%
    st_drop_geometry() %>%
    inner_join(.,threadspots_lt, by=c("CELLCODE"="CELLCOD")) %>%
    st_as_sf()

g_e_t <- g_base +
    geom_sf(intersection_spots, mapping=aes(fill="red"), alpha=0.3, size=0.1, na.rm = TRUE) +
    ggtitle("Endemic hotspots and Threadspots")+
#    scale_fill_gradient(low = "yellow", high = "red", na.value = "transparent")+
    theme_bw()

ggsave("../plots/crete-hotspots-threadspots.png", plot=g_e_t, device="png")

g_e_t

```

Overlap of hotspots and threadspots with Natura2000 protected areas.

```{r, warning=FALSE, message=FALSE, echo=T}

endemic_hotspots_natura <- st_intersection(endemic_hotspots, natura_crete_land_sci)
print("Total area of endemic hotspots")
sum(units::set_units(st_area(endemic_hotspots),km^2))

print("Overlap area of endemic hotspots with Natura2000 sci")
sum(units::set_units(st_area(endemic_hotspots_natura),km^2))

```
Threadspots with Natura2000

```{r, warning=FALSE, message=FALSE, echo=T}
threadspots_natura <- st_intersection(threadspots_lt, natura_crete_land_sci)

print("Total area of threadspots as they were inferred with the PACA method")
sum(units::set_units(st_area(threadspots_lt),km^2))

print("Ovelap area of the PACA threadspots")
sum(units::set_units(st_area(threadspots_natura),km^2))
```

